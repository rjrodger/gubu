!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Gubu=e()}}((function(){var e={},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.Gubu=void 0;const n=t({name:"gubu",version:"0.0.4",description:"An object shape validation utility.",main:"gubu.js",browser:"gubu.min.js",type:"commonjs",types:"gubu.d.ts",homepage:"https://github.com/rjrodger/gubu",keywords:["gubu"],author:"Richard Rodger (http://richardrodger.com)",repository:{type:"git",url:"git://github.com/rjrodger/gubu.git"},scripts:{test:"jest --coverage","test-some":"jest -t","test-watch":"jest --coverage --watchAll","test-web":"npm run build-web && browserify -o test/web.js -e test/entry.js -im && open test/web.html",watch:"tsc -w -d",build:"tsc -d","build-web":"cp gubu.js gubu.min.js && browserify -o gubu.min.js -e gubu.web.js -s Gubu -im -p tinyify",clean:"rm -rf node_modules yarn.lock package-lock.json",reset:"npm run clean && npm i && npm test","repo-tag":"REPO_VERSION=`node -e \"console.log(require('./package').version)\"` && echo TAG: v$REPO_VERSION && git commit -a -m v$REPO_VERSION && git push && git tag v$REPO_VERSION && git push --tags;","repo-publish":"npm run clean && npm i && npm run repo-publish-quick","repo-publish-quick":"npm run build && npm run test && npm run build-web && npm run test-web && npm run repo-tag && npm publish --access public --registry https://registry.npmjs.org "},license:"MIT",engines:{node:">=12"},files:["*.ts","*.js","*.map","LICENSE"],devDependencies:{"@types/jest":"^27.0.3",jest:"^27.4.5","ts-jest":"^27.1.2",typescript:"^4.5.4",browserify:"^17.0.0",tinyify:"^3.0.0"},dependencies:{}}),r=Symbol.for("gubu$"),o={gubu$:r,v$:n.default.version};class i extends TypeError{constructor(e,t,n){super(t.map(e=>e.t).join("\n")),this.gubu=!0,this.name="GubuError",this.code=e,this.desc=()=>({name:"GubuError",code:e,err:t,ctx:n})}toJSON(){return{...this,err:this.desc().err,name:this.name,message:this.message}}}const u={String:!0,Number:!0,Boolean:!0,Object:!0,Array:!0,Function:!0,Symbol:!0,BigInt:!0},s={string:"",number:0,boolean:!1,object:{},array:[],function:()=>{},symbol:Symbol(""),bigint:BigInt(0),null:null};function l(e){var t,i,l,c,a,d;if(null!=e&&(null===(t=e.$)||void 0===t?void 0:t.gubu$)){if(r===e.$.gubu$)return e;if(!0===e.$.gubu$){let t={...e};return t.$={v$:n.default.version,...t.$,gubu$:r},t.v=null!=t.v&&"object"==typeof t.v?{...t.v}:t.v,t.t=t.t||typeof t.v,"function"===t.t&&u[t.v.name]&&(t.t=t.v.name.toLowerCase(),t.v=R(s[t.t])),t.k=null==t.k?"":t.k,t.r=!!t.r,t.o=!!t.o,t.d=null==t.d?-1:t.d,t.u=t.u||{},(null===(i=t.u.list)||void 0===i?void 0:i.specs)&&(t.u.list.specs=[...t.u.list.specs]),t}}let p=null===e?"null":typeof e,f=e,b=!1,v=void 0,y={};if("object"===(p="undefined"===p?"any":p))Array.isArray(e)?p="array":null!=f&&Function!==f.constructor&&Object!==f.constructor&&null!=f.constructor&&(p="instance",y.n=f.constructor.name,y.i=f.constructor);else if("function"===p)if(u[e.name])p=e.name.toLowerCase(),b=!0,f=R(s[p]);else if(e.gubu===o||!0===(null===(l=e.$)||void 0===l?void 0:l.gubu)){let t=e.spec?e.spec():e;p=t.t,f=t.v,b=t.r,y=t.u}else void 0===e.prototype&&Function===e.constructor||Function===(null===(c=e.prototype)||void 0===c?void 0:c.constructor)?(p="custom",v=f):(p="instance",b=!0,y.n=null===(d=null===(a=f.prototype)||void 0===a?void 0:a.constructor)||void 0===d?void 0:d.name,y.i=f);else"number"===p&&isNaN(f)&&(p="nan");let m={$:o,t:p,v:null==f||"object"!==p&&"array"!==p?f:{...f},r:b,o:!1,k:"",d:-1,u:y};return v&&(m.b=v),m}function c(e,t){const n=null==t?{}:t;n.name=null==n.name?(""+Math.random()).substring(2):""+n.name;let u=l({"":e}),s=function(e,t){var n,o,s,c;const d=t||{},p={"":e},f=[u,-1],b=[p,-1],y=[];let m,g,h=-1,j=2,I=0,$=-1,k=0,w=[];for(;;){for(m=f[I];+m;)m=f[I=m],h--;if($=I+1,g=b[I],!m)break;-1<h&&(y[h]=m.k),h++,k=0,I=j;let e=null==m.v?[]:Object.keys(m.v);if("array"===m.t){e=Object.keys(g);for(let t in m.v)"0"===t||e.includes(t)||e.splice(parseInt(t)-1,0,""+(parseInt(t)-1))}for(let t of e){y[h]=t;let e=g[t],i=typeof e;"number"===i&&isNaN(e)&&(i="nan");let u=m.v[t],p=null;if("array"===m.t){let e=""+(parseInt(t)+1);void 0!==(u=m.v[e])&&(p=u=r===(null===(n=u.$)||void 0===n?void 0:n.gubu$)?u:m.v[e]=l(u)),void 0===u&&(u=m.v[0],t="0",void 0===u&&(u=m.v[0]=v()),p=null===u?l(u):r===(null===(o=u.$)||void 0===o?void 0:o.gubu$)?u:m.v[t]=l(u))}else p=null!=u&&r===(null===(s=u.$)||void 0===s?void 0:s.gubu$)?u:m.v[t]=l(u);p.k=t,p.d=h;let O,N="",A=0;"list"===p.t?(O=p.u.list.specs,N=p.u.list.kind):O=[p];let E=[];for(let n=0;n<O.length;n++){let o=O[n],u=(o=r===(null===(c=o.$)||void 0===c?void 0:c.gubu$)?o:O[n]=l(o)).t,s=!0,p=!1;if(o.b){let n=a(o.b,e,{dI:h,nI:j,sI:$,pI:I,cN:k,key:t,node:o,src:g,nodes:f,srcs:b,path:y,terr:E,err:w,ctx:d});s=n.pass,void 0!==n.val&&(e=g[t]=n.val),void 0!==n.node&&(o=n.node),void 0!==n.type&&(u=n.type),void 0!==n.done&&(p=n.done),j=void 0===n.nI?j:n.nI,$=void 0===n.sI?$:n.sI,I=void 0===n.pI?I:n.pI,k=void 0===n.cN?k:n.cN}if(p||("none"===u?E.push(S("none",e,y,h,o,1070)):"object"===u?o.r&&void 0===e?E.push(S("required",e,y,h,o,1010)):void 0===e||null!==e&&"object"===i&&!Array.isArray(e)?null==g[t]&&o.o||(f[j]=o,b[j]=g[t]=g[t]||{},j++,k++):E.push(S("type",e,y,h,o,1020)):"array"===u?o.r&&void 0===e?E.push(S("required",e,y,h,o,1030)):void 0===e||Array.isArray(e)?null==g[t]&&o.o||(f[j]=o,b[j]=g[t]=g[t]||[],j++,k++):E.push(S("type",e,y,h,o,1040)):"any"===u||"custom"===u||void 0===e||u===i||"instance"===u&&o.u.i&&e instanceof o.u.i||"null"===u&&null===e?void 0===e?o.r?(E.push(S("required",e,y,h,o,1060)),s=!1):void 0===o.v||o.o||(g[t]=o.v):"string"===u&&""===e&&(o.r&&!o.u.empty?E.push(S("required",e,y,h,o,1080)):o.u.empty||(g[t]=o.v)):(E.push(S("type",e,y,h,o,1050)),s=!1)),o.a){let n=a(o.a,e,{dI:h,nI:j,sI:$,pI:I,cN:k,key:t,node:o,src:g,nodes:f,srcs:b,path:y,terr:E,err:w,ctx:d});s=n.pass,void 0!==n.val&&(e=g[t]=n.val),j=void 0===n.nI?j:n.nI,$=void 0===n.sI?$:n.sI,I=void 0===n.pI?I:n.pI,k=void 0===n.cN?k:n.cN}if(s){if("one"===N)break}else if(A++,"all"===N)break}0<E.length&&("one"!==N&&"some"!==N||!(A<O.length))&&w.push(...E)}0<k?f[j++]=$:(I=$,h--)}if(0<w.length){if(!d.err)throw new i("shape",w,d);d.err.push(...w)}return p[""]};return s.spec=()=>(s(void 0,{err:[]}),JSON.parse(E(u.v[""],(e,t)=>r===t||t))),s.toString=()=>`[Gubu ${n.name}]`,s.gubu=o,s}function a(e,t,n){let r={pass:!0,done:!1};if((void 0!==t||n.node.r)&&(!e(t,r,n)||r.err)){let e=r.why||"custom",o=d(n.path,n.dI);"object"==typeof r.err?n.terr.push(...[r.err].flat().map(e=>(e.p=null==e.p?o:e.p,e.m=null==e.m?2010:e.m,e))):n.terr.push(S(e,t,n.path,n.dI,n.node,1040)),r.pass=!1}return r}function d(e,t){return e.slice(1,t+1).filter(e=>null!=e).join(".")}const p=function(e){let t=N(this,e);return t.r=!0,t},f=function(e){let t=N(this,e);return t.r=!1,t.o=!0,t},b=function(e){let t=N(this,e);return t.u.empty=!0,t},v=function(e){let t=N(this,e);return t.t="any",void 0!==e&&(t.v=e),t},y=function(e){let t=N(this,e);return t.t="none",t},m=function(e){return function(...t){let n=N();return n.t="list",n.u.list={specs:t.map(e=>N(e)).map(t=>(t.u.list={kind:e},t)),kind:e},n}},g=m("one"),h=m("all"),j=function(e,t){let n=N(this,t);return n.b=e,n},I=function(e,t){let n=N(this,t);return n.a=e,n},$=function(e){let t=N(this,e);return t.b=(e,n,r)=>{if(null!=e&&"object"==typeof e){let o=Object.keys(e),i=t.v;"array"===r.node.t&&(i=Object.keys(t.v).slice(1).map(e=>{let t=parseInt(e);return isNaN(t)?e:t-1}).reduce((e,t)=>(e[t]=!0,e),{})),n.err=[];for(let u of o)void 0===i[u]&&n.err.push(S("closed",e,r.path,r.dI,t,3010,"",{k:u}));return 0===n.err.length}return!0},t},k=function(e,t){let n=N(this,t),r="string"==typeof e?e:("object"==typeof e&&e||{}).name;return null!=r&&""!=r&&(n.b=(e,t,n)=>((n.ctx.ref=n.ctx.ref||{})[r]=n.node,!0)),n},w=function(e,t){let n=N(this,t),r="object"==typeof e&&e||{},o="string"==typeof e?e:r.name,i=!!r.fill;return null!=o&&""!=o&&(n.b=(e,t,n)=>{if(void 0!==e||i){let e=n.ctx.ref=n.ctx.ref||{};if(void 0!==e[o]){let r={...e[o]};r.k=n.node.k,r.t=r.t||"none",t.node=r,t.type=r.t}}return!0}),n},O=function(e,t){let n=N(this,t),r="object"==typeof e&&e||{},o="string"==typeof e?e:r.name;return null!=o&&""!=o&&(n.a=(e,t,n)=>(n.src[o]=e,r.keep||delete n.src[n.key],!0)),n};function N(e,t){let n=l(void 0===e||e.window===e?t:e);return Object.assign(n,{After:I,All:h,Any:v,Before:j,Closed:$,Define:k,Empty:b,None:y,One:g,Optional:f,Refer:w,Rename:O,Required:p})}function A(e,t,n,r){return S(r||"custom",e,t.path,t.dI,t.node,4e3,n)}function S(e,t,n,r,o,i,u,s,l){let c={n:o,s:t,p:d(n,r),w:e,m:i,t:""},a=(void 0===t?"":E(t)).replace(/"/g,"");return a=a.substring(0,77)+(77<a.length?"...":""),c.t=null==u||""===u?`Validation failed for path "${c.p}" with value "${a}" because `+("type"===e?"instance"===o.t?"the value is not an instance of "+o.u.n:"the value is not of type "+o.t:"required"===e?"the value is required":"closed"===e?`the property "${null==s?void 0:s.k}" is not allowed`:"none"===e?"no value is allowed":`check "${e+(l?": "+l:"")}" failed`)+".":u.replace(/\$VALUE/g,a).replace(/\$PATH/g,c.p),c}function E(e,t){try{return JSON.stringify(e,(e,n)=>(t&&(n=t(e,n)),"bigint"==typeof n&&(n=n.toString()),n))}catch(n){return JSON.stringify(String(e))}}function R(e){return null==e||"object"!=typeof e?e:JSON.parse(JSON.stringify(e))}const q=e=>l({...e,$:{gubu$:!0}});Object.assign(c,{After:I,All:h,Any:v,Before:j,Closed:$,Define:k,Empty:b,None:y,One:g,Optional:f,Refer:w,Rename:O,Required:p,G$:q,buildize:N,makeErr:A}),Object.defineProperty(c,"name",{value:"gubu"});const _=c;e.Gubu=_;const{Gubu:x}=e;return x}));