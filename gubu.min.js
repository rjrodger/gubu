!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Gubu=e()}}((function(){var e={},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.GRequired=e.GRename=e.GRefer=e.GOptional=e.GOne=e.GNone=e.GEmpty=e.GDefine=e.GClosed=e.GBefore=e.GAny=e.GAll=e.GAfter=e.Required=e.Rename=e.Refer=e.Optional=e.One=e.None=e.Empty=e.Define=e.Closed=e.Before=e.Any=e.All=e.After=e.makeErr=e.buildize=e.norm=e.G$=e.Gubu=void 0;const n=t({name:"gubu",version:"0.0.3",description:"An object shape validation utility.",main:"gubu.js",type:"commonjs",types:"gubu.d.ts",homepage:"https://github.com/rjrodger/gubu",keywords:["gubu"],author:"Richard Rodger (http://richardrodger.com)",repository:{type:"git",url:"git://github.com/rjrodger/gubu.git"},scripts:{test:"jest --coverage","test-some":"jest -t","test-watch":"jest --coverage --watchAll",watch:"tsc -w -d",build:"tsc -d","build-web":"cp gubu.js gubu.min.js && browserify -o gubu.min.js -e gubu.js -s Gubu -im -i assert -p tinyify",clean:"rm -rf node_modules yarn.lock package-lock.json",reset:"npm run clean && npm i && npm test",browserify:"^17.0.0",tinyify:"^3.0.0","repo-tag":"REPO_VERSION=`node -e \"console.log(require('./package').version)\"` && echo TAG: v$REPO_VERSION && git commit -a -m v$REPO_VERSION && git push && git tag v$REPO_VERSION && git push --tags;","repo-publish":"npm run clean && npm i && npm run repo-publish-quick","repo-publish-quick":"npm run build && npm run test && npm run repo-tag && npm publish --access public --registry https://registry.npmjs.org "},license:"MIT",engines:{node:">=12"},files:["*.ts","*.js","*.map","LICENSE"],devDependencies:{"@types/jest":"^27.0.3",jest:"^27.4.5","ts-jest":"^27.1.2",typescript:"^4.5.4",browserify:"^17.0.0",tinyify:"^3.0.0"},dependencies:{}}),o=Symbol.for("gubu$"),r={gubu$:o,v$:n.default.version};class i extends TypeError{constructor(e,t,n){super(t.map(e=>e.t).join("\n")),this.gubu=!0,this.name="GubuError",this.code=e,this.desc=()=>({name:"GubuError",code:e,err:t,ctx:n})}toJSON(){return{...this,err:this.desc().err,name:this.name,message:this.message}}}const u={String:!0,Number:!0,Boolean:!0,Object:!0,Array:!0,Function:!0,Symbol:!0,BigInt:!0},s={string:"",number:0,boolean:!1,object:{},array:[],function:()=>{},symbol:Symbol(""),bigint:BigInt(0),null:null};function l(e){var t,i,l,c,a,d,p;if(null!=e&&(null===(t=e.$)||void 0===t?void 0:t.gubu$)){if(o===e.$.gubu$)return e;if(!0===e.$.gubu$){let t={...e};return t.$={v$:n.default.version,...t.$,gubu$:o},t.v=null!=t.v&&"object"==typeof t.v?{...t.v}:t.v,t.t=t.t||typeof t.v,"function"===t.t&&u[t.v.name]&&(t.t=t.v.name.toLowerCase(),t.v=w(s[t.t])),t.k=null==t.k?"":t.k,t.r=!!t.r,t.d=null==t.d?-1:t.d,t.u=t.u||{},(null===(i=t.u.list)||void 0===i?void 0:i.specs)&&(t.u.list.specs=[...t.u.list.specs]),t}}let f=null===e?"null":typeof e,v=e,y=!1,b=void 0,m={};if("object"===(f=void 0===f?"any":f))Array.isArray(e)?f="array":null!=v&&Function!==v.constructor&&Object!==v.constructor&&null!=v.constructor&&(f="instance",m.n=null===(l=v.constructor)||void 0===l?void 0:l.name,m.i=v.constructor);else if("function"===f)if(u[e.name])f=e.name.toLowerCase(),y=!0,v=w(s[f]);else if(e.gubu===r||!0===(null===(c=e.$)||void 0===c?void 0:c.gubu)){let t=(null==e?void 0:e.spec)?e.spec():e;f=t.t,v=t.v,y=t.r,m=t.u}else void 0===e.prototype&&Function===e.constructor||Function===(null===(a=e.prototype)||void 0===a?void 0:a.constructor)?(f="custom",b=v):(f="instance",y=!0,m.n=null===(p=null===(d=v.prototype)||void 0===d?void 0:d.constructor)||void 0===p?void 0:p.name,m.i=v);else"number"===f&&isNaN(v)&&(f="nan");let g={$:r,t:f,v:null==v||"object"!==f&&"array"!==f?v:{...v},r:y,k:"",d:-1,u:m};return b&&(g.b=b),g}function c(e,t){const n=null==t?{}:t;n.name=null==n.name?(""+Math.random()).substring(2):""+n.name;let u=l({"":e}),s=function(e,t){var n,r,s,c;const d=t||{},p={"":e},f=[u,-1],v=[p,-1],b=[];let m,g,h=-1,j=2,$=0,G=-1,I=0,O=[];for(;;){for(m=f[$];+m;)m=f[$=m],h--;if(G=$+1,g=v[$],!m)break;-1<h&&(b[h]=m.k),h++,I=0,$=j;let e=Object.keys(m.v);if("array"===m.t){e=Object.keys(g);for(let t in m.v)"0"===t||e.includes(t)||e.splice(parseInt(t)-1,0,""+(parseInt(t)-1))}for(let t of e){b[h]=t;let e=g[t],i=typeof e;"number"===i&&isNaN(e)&&(i="nan");let u=m.v[t],p=null;if("array"===m.t){let e=""+(parseInt(t)+1);void 0!==(u=m.v[e])&&(p=u=o===(null===(n=u.$)||void 0===n?void 0:n.gubu$)?u:u=m.v[e]=l(u)),void 0===u&&(u=m.v[0],t="0",void 0===u&&(u=m.v[0]=y()),p=u=o===(null===(r=u.$)||void 0===r?void 0:r.gubu$)?u:u=m.v[t]=l(u))}else p=null!=u&&o===(null===(s=u.$)||void 0===s?void 0:s.gubu$)?u:u=m.v[t]=l(u);p.k=t,p.d=h;let k,A="",R=0;"list"===p.t?(k=p.u.list.specs,A=p.u.list.kind):k=[p];let w=[];for(let n=0;n<k.length;n++){let r=k[n],u=(r=o===(null===(c=r.$)||void 0===c?void 0:c.gubu$)?r:k[n]=l(r)).t,s=!0,p=!1;if(r.b){let n=a(r.b,e,{dI:h,nI:j,sI:G,pI:$,cN:I,key:t,node:r,src:g,nodes:f,srcs:v,path:b,terr:w,err:O,ctx:d});s=n.pass,void 0!==n.val&&(e=g[t]=n.val),void 0!==n.node&&(r=n.node),void 0!==n.type&&(u=n.type),void 0!==n.done&&(p=n.done),j=void 0===n.nI?j:n.nI,G=void 0===n.sI?G:n.sI,$=void 0===n.pI?$:n.pI,I=void 0===n.cN?I:n.cN}if(p||("none"===u?w.push(N("none",e,b,h,r,1070)):"object"===u?r.r&&void 0===e?w.push(N("required",e,b,h,r,1010)):void 0===e||null!==e&&"object"===i&&!Array.isArray(e)?(f[j]=r,v[j]=g[t]=g[t]||{},j++,I++):w.push(N("type",e,b,h,r,1020)):"array"===u?r.r&&void 0===e?w.push(N("required",e,b,h,r,1030)):void 0===e||Array.isArray(e)?(f[j]=r,v[j]=g[t]=g[t]||[],j++,I++):w.push(N("type",e,b,h,r,1040)):"any"===u||"custom"===u||void 0===e||u===i||"instance"===u&&r.u.i&&e instanceof r.u.i||"null"===u&&null===e?void 0===e?r.r?(w.push(N("required",e,b,h,r,1060)),s=!1):void 0!==r.v&&(g[t]=r.v):"string"===u&&""===e&&(r.r&&!r.u.empty?w.push(N("required",e,b,h,r,1080)):r.u.empty||(g[t]=r.v)):(w.push(N("type",e,b,h,r,1050)),s=!1)),r.a){let n=a(r.a,e,{dI:h,nI:j,sI:G,pI:$,cN:I,key:t,node:r,src:g,nodes:f,srcs:v,path:b,terr:w,err:O,ctx:d});s=n.pass,void 0!==n.val&&(e=g[t]=n.val),j=void 0===n.nI?j:n.nI,G=void 0===n.sI?G:n.sI,$=void 0===n.pI?$:n.pI,I=void 0===n.cN?I:n.cN}if(s){if("one"===A)break}else if(R++,"all"===A)break}0<w.length&&("one"!==A&&"some"!==A||!(R<k.length))&&O.push(...w)}0<I?f[j++]=G:($=G,h--)}if(0<O.length){if(!d.err)throw new i("shape",O,d);d.err.push(...O)}return p[""]};return s.spec=()=>(s(void 0,{err:[]}),JSON.parse(R(u.v[""],(e,t)=>o===t||t))),s.toString=()=>`[Gubu ${n.name}]`,s.gubu=r,s}function a(e,t,n){let o={pass:!0,done:!1};if((void 0!==t||n.node.r)&&(!e(t,o,n)||o.err)){let e=o.why||"custom",r=d(n.path,n.dI);"object"==typeof o.err?n.terr.push(...[o.err].flat().map(e=>(e.p=null==e.p?r:e.p,e.m=null==e.m?2010:e.m,e))):n.terr.push(N(e,t,n.path,n.dI,n.node,1040)),o.pass=!1}return o}function d(e,t){return e.slice(1,t+1).filter(e=>null!=e).join(".")}e.norm=l;const p=function(e){let t=A(this||e);return t.r=!0,t};e.Required=p;const f=function(e){let t=A(this||e);return t.r=!1,t};e.Optional=f;const v=function(e){let t=A(this||e);return t.u.empty=!0,t};e.Empty=v;const y=function(e){let t=A(this||e);return t.t="any",void 0!==e&&(t.v=e),t};e.Any=y;const b=function(e){let t=A(this||e);return t.t="none",t};e.None=b;const m=function(e){return function(...t){let n=A();return n.t="list",n.u.list={specs:t.map(e=>A(e)).map(t=>(t.u.list={kind:e},t)),kind:e},n}},g=m("one");e.One=g;const h=m("all");e.All=h;const j=function(e,t){let n=A(this||t);return n.b=e,n};e.Before=j;const $=function(e,t){let n=A(this||t);return n.a=e,n};e.After=$;const G=function(e){let t=A(this||e);return t.b=(e,n,o)=>{if(null!=e&&"object"==typeof e){let r=Object.keys(e),i=t.v;"array"===o.node.t&&(i=Object.keys(t.v).slice(1).map(e=>{let t=parseInt(e);return isNaN(t)?e:t-1}).reduce((e,t)=>(e[t]=!0,e),{}));for(let u of r)if(void 0===i[u])return n.err=N("closed",e,o.path,o.dI,t,3010,"",{k:u}),!1}return!0},t};e.Closed=G;const I=function(e,t){let n=A(this||t),o="string"==typeof e?e:("object"==typeof e&&e||{}).name;return null!=o&&""!=o&&(n.b=(e,t,n)=>((n.ctx.ref=n.ctx.ref||{})[o]=n.node,!0)),n};e.Define=I;const O=function(e,t){let n=A(this||t),o="object"==typeof e&&e||{},r="string"==typeof e?e:o.name,i=!!o.fill;return null!=r&&""!=r&&(n.b=(e,t,n)=>{if(void 0!==e||i){let e=n.ctx.ref=n.ctx.ref||{};if(void 0!==e[r]){let o={...e[r]};o.k=n.node.k,o.t=o.t||"none",t.node=o,t.type=o.t}}return!0}),n};e.Refer=O;const k=function(e,t){let n=A(this||t),o="object"==typeof e&&e||{},r="string"==typeof e?e:o.name;return null!=r&&""!=r&&(n.a=(e,t,n)=>(n.src[r]=e,o.keep||delete n.src[n.key],!0)),n};function A(e){let t=l(e);return Object.assign(t,{After:$,All:h,Any:y,Before:j,Closed:G,Define:I,Empty:v,None:b,One:g,Optional:f,Refer:O,Rename:k,Required:p})}function N(e,t,n,o,r,i,u,s,l){let c={n:r,s:t,p:d(n,o),w:e,m:i,t:""},a=(void 0===t?"":R(t)).replace(/"/g,"");return a=a.substring(0,77)+(77<a.length?"...":""),c.t=null==u||""===u?`Validation failed for path "${c.p}" with value "${a}" because `+("type"===e?"instance"===r.t?"the value is not an instance of "+r.u.n:"the value is not of type "+r.t:"required"===e?"the value is required":"closed"===e?`the property "${null==s?void 0:s.k}" is not allowed`:"none"===e?"no value is allowed":`check "${e+(l?": "+l:"")}" failed`)+".":u.replace(/\$VALUE/g,a).replace(/\$PATH/g,c.p),c}function R(e,t){try{return JSON.stringify(e,(e,n)=>(t&&(n=t(e,n)),"bigint"==typeof n&&(n=n.toString()),n))}catch(n){return JSON.stringify(String(e))}}function w(e){return null==e||"object"!=typeof e?e:JSON.parse(JSON.stringify(e))}e.Rename=k,e.buildize=A,e.makeErr=function(e,t,n,o){return N(o||"custom",e,t.path,t.dI,t.node,4e3,n)},Object.assign(c,{After:$,All:h,Any:y,Before:j,Closed:G,Define:I,Empty:v,None:b,One:g,Optional:f,Refer:O,Rename:k,Required:p}),Object.defineProperty(c,"name",{value:"gubu"}),e.G$=e=>l({...e,$:{gubu$:!0}});const E=c;e.Gubu=E;const S=$;e.GAfter=S;const q=h;e.GAll=q;const _=y;e.GAny=_;const x=j;e.GBefore=x;const B=G;e.GClosed=B;const C=I;e.GDefine=C;const D=v;e.GEmpty=D;const P=b;e.GNone=P;const J=g;e.GOne=J;const V=f;e.GOptional=V;const F=O;e.GRefer=F;const L=k;e.GRename=L;const M=p;return e.GRequired=M,e}));