!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Gubu=e()}}((function(){var e={},t={},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Gubu=void 0;const r=n({name:"gubu",version:"0.2.0",description:"An object shape validation utility.",main:"gubu.js",browser:"gubu.min.js",type:"commonjs",types:"gubu.d.ts",homepage:"https://github.com/rjrodger/gubu",keywords:["gubu"],author:"Richard Rodger (http://richardrodger.com)",repository:{type:"git",url:"git://github.com/rjrodger/gubu.git"},scripts:{test:"jest --coverage","test-some":"jest -t","test-watch":"jest --coverage --watchAll","test-web":"npm run build && npm run build-web && browserify -i util -o test/web.js -e test/entry.js -im && open test/web.html",watch:"tsc -w -d",build:"tsc -d","build-web":"cp gubu.js gubu.min.js && browserify -i util -o gubu.min.js -e gubu.web.js -s Gubu -im -p tinyify",lint:"markdownlint README.md",clean:"rm -rf node_modules yarn.lock package-lock.json",reset:"npm run clean && npm i && npm test","repo-tag":"REPO_VERSION=`node -e \"console.log(require('./package').version)\"` && echo TAG: v$REPO_VERSION && git commit -a -m v$REPO_VERSION && git push && git tag v$REPO_VERSION && git push --tags;","repo-publish":"npm run clean && npm i && npm run repo-publish-quick","repo-publish-quick":"npm run build && npm run test && npm run build-web && npm run test-web && npm run repo-tag && npm publish --access public --registry https://registry.npmjs.org "},license:"MIT",engines:{node:">=12"},files:["*.ts","*.js","*.map","LICENSE"],devDependencies:{"@types/jest":"^27.4.0",browserify:"^17.0.0",jest:"^27.4.7",tinyify:"^3.0.0","ts-jest":"^27.1.2",typescript:"^4.5.4"}}),o=Symbol.for("gubu$"),i={gubu$:o,v$:r.default.version};class l{constructor(e,t,n,r){this.match=!1,this.dI=0,this.nI=2,this.cI=-1,this.pI=0,this.sI=-1,this.valType="never",this.isRoot=!1,this.key="",this.type="never",this.stop=!0,this.nextSibling=!0,this.fromDefault=!1,this.ignoreVal=!1,this.err=[],this.parents=[],this.keys=[],this.path=[],this.root=e,this.vals=[e,-1],this.node=t,this.nodes=[t,-1],this.ctx=n||{},this.match=!!r}next(){this.stop=!1,this.fromDefault=!1,this.ignoreVal=!1,this.isRoot=0===this.pI;let e=this.nodes[this.pI];for(;+e;)this.pI=+e,e=this.nodes[this.pI],this.dI--;e?(this.node=e,this.updateVal(this.vals[this.pI]),this.key=this.keys[this.pI],this.cI=this.pI,this.sI=this.pI+1,this.parent=this.parents[this.pI],this.nextSibling=!0,this.type=this.node.t,this.path[this.dI]=this.key,this.oval=this.val):this.stop=!0}updateVal(e){this.val=e,this.valType=typeof this.val,"number"===this.valType&&isNaN(this.val)&&(this.valType="nan"),this.isRoot&&!this.match&&(this.root=this.val)}}class u extends TypeError{constructor(e,t,n){super(t.map(e=>e.t).join("\n")),this.gubu=!0,this.name="GubuError",this.code=e,this.desc=()=>({name:"GubuError",code:e,err:t,ctx:n})}toJSON(){return{...this,err:this.desc().err,name:this.name,message:this.message}}}const s={String:!0,Number:!0,Boolean:!0,Object:!0,Array:!0,Function:!0,Symbol:!0,BigInt:!0},a={string:"",number:0,boolean:!1,object:{},array:[],symbol:Symbol(""),bigint:BigInt(0),null:null};function p(e,t){var n,l,u,p,f;if(null!=e&&(null===(n=e.$)||void 0===n?void 0:n.gubu$)){if(o===e.$.gubu$)return e.d=null==t?e.d:t,e;if(!0===e.$.gubu$){let n={...e};return n.$={v$:r.default.version,...n.$,gubu$:o},n.v=null!=n.v&&"object"==typeof n.v?{...n.v}:n.v,n.t=n.t||typeof n.v,"function"===n.t&&s[n.v.name]&&(n.t=n.v.name.toLowerCase(),n.v=_(a[n.t])),n.r=!!n.r,n.o=!!n.o,n.d=null==t?null==n.d?-1:n.d:t,n.b=n.b||[],n.a=n.a||[],n.u=n.u||{},n}}let c=null===e?"null":typeof e,d=e,h=!1,v=void 0,m={};if("object"===(c="undefined"===c?"any":c))Array.isArray(e)?c="array":null!=d&&Function!==d.constructor&&Object!==d.constructor&&null!=d.constructor&&(c="instance",m.n=d.constructor.name,m.i=d.constructor);else if("function"===c)if(s[e.name])c=e.name.toLowerCase(),h=!0,d=_(a[c]);else if(e.gubu===i||!0===(null===(l=e.$)||void 0===l?void 0:l.gubu)){let t=e.spec?e.spec():e;c=t.t,d=t.v,h=t.r,m=t.u}else void 0===e.prototype&&Function===e.constructor||Function===(null===(u=e.prototype)||void 0===u?void 0:u.constructor)?(c="custom",v=d,d=void 0):(c="instance",h=!0,m.n=null===(f=null===(p=d.prototype)||void 0===p?void 0:p.constructor)||void 0===f?void 0:f.name,m.i=d);else"number"===c&&isNaN(d)&&(c="nan");let b={$:i,t:c,v:null==d||"object"!==c&&"array"!==c?d:{...d},r:h,o:!1,d:null==t?-1:t,u:m,a:[],b:[]};return v&&b.b.push(v),b}function f(t,n){const r=null==n?{}:n;r.name=null==r.name?"G"+(""+Math.random()).substring(2,8):""+r.name;let s=p(t,0);function a(e,t,n){let r=new l(e,s,t,n);for(;r.next(),!r.stop;){let e=!1;if(0<r.node.b.length)for(let t=0;t<r.node.b.length;t++){let n=c(r.node.b[t],r);void 0!==n.done&&(e=n.done)}if(!e)if("never"===r.type)r.err.push(M("never",r,1070));else if("object"===r.type){let e;if(r.node.r&&void 0===r.val?r.err.push(M("required",r,1010)):void 0===r.val||null!==r.val&&"object"===r.valType&&!Array.isArray(r.val)?r.node.o&&null==r.val||(r.updateVal(r.val||(r.fromDefault=!0,{})),e=r.val):(r.err.push(M("type",r,1020)),e=Array.isArray(r.val)?r.val:{}),null!=(e=null==e&&!1===r.ctx.err?{}:e)){let t=Object.keys(r.node.v);if(0<t.length){r.pI=r.nI;for(let n of t){let t=r.node.v[n]=p(r.node.v[n],1+r.dI);r.nodes[r.nI]=t,r.vals[r.nI]=e[n],r.parents[r.nI]=e,r.keys[r.nI]=n,r.nI++}r.dI++,r.nodes[r.nI++]=r.sI,r.nextSibling=!1}}}else if("array"===r.type)if(r.node.r&&void 0===r.val)r.err.push(M("required",r,1030));else if(void 0===r.val||Array.isArray(r.val)){if(!r.node.o||null!=r.val){r.updateVal(r.val||(r.fromDefault=!0,[]));let e=Object.keys(r.node.v).filter(e=>!isNaN(+e));if(0<r.val.length||1<e.length){r.pI=r.nI;let t=void 0===r.node.v[0]?b():r.node.v[0]=p(r.node.v[0],1+r.dI),n=1;if(1<e.length)for(;n<e.length;n++){let e=r.node.v[n]=p(r.node.v[n],1+r.dI);r.nodes[r.nI]=e,r.vals[r.nI]=r.val[n-1],r.parents[r.nI]=r.val,r.keys[r.nI]=""+(n-1),r.nI++}for(let e=n-1;e<r.val.length;e++)r.nodes[r.nI]=t,r.vals[r.nI]=r.val[e],r.parents[r.nI]=r.val,r.keys[r.nI]=""+e,r.nI++;r.dI++,r.nodes[r.nI++]=r.sI,r.nextSibling=!1}}}else r.err.push(M("type",r,1040));else if("any"===r.type||"custom"===r.type||"list"===r.type||void 0===r.val||r.type===r.valType||"instance"===r.type&&r.node.u.i&&r.val instanceof r.node.u.i||"null"===r.type&&null===r.val)if(void 0===r.val){let e=r.path[r.dI];!r.node.r||"undefined"===r.type&&r.parent.hasOwnProperty(e)?("custom"!==r.type&&void 0!==r.node.v&&!r.node.o||"undefined"===r.type)&&(r.updateVal(r.node.v),r.fromDefault=!0):r.err.push(M("required",r,1060))}else"string"!==r.type||""!==r.val||r.node.u.empty||r.err.push(M("required",r,1080));else r.err.push(M("type",r,1050));if(0<r.node.a.length)for(let t=0;t<r.node.a.length;t++){let n=c(r.node.a[t],r);void 0!==n.done&&(e=n.done)}r.match||!r.parent||e||r.ignoreVal||r.node.o||(r.parent[r.key]=r.val),r.nextSibling&&(r.pI=r.sI)}if(0<r.err.length)if(Array.isArray(r.ctx.err))r.ctx.err.push(...r.err);else if(!r.match&&!1!==r.ctx.err)throw new u("shape",r.err,r.ctx);return r.match?0===r.err.length:r.root}function f(e,t){return a(e,t,!1)}f.valid=function(e,t){let n=t||{};return a(e,n,!1),null==n.err||0===n.err.length},f.match=(e,t)=>a(e,t=t||{},!0),f.spec=()=>(f(void 0,{err:!1}),JSON.parse(L(s,(e,t)=>o===t||t,!0)));let d="";return f.toString=()=>(d=N(""===d?L(s&&s.$&&(o===s.$.gubu$||!0===s.$.gubu$)?s.v:s):d),`[Gubu ${r.name} ${d}]`),e.inspect&&e.inspect.custom&&(f[e.inspect.custom]=f.toString),f.gubu=i,f}function c(e,t){let n,r={},o=!1;try{o=e(t.val,r,t)}catch(l){n=l}let i=Array.isArray(r.err)?0<r.err.length:null!=r.err;if(!o||i){if(void 0===t.val&&(t.node.o||!t.node.r)&&!0!==r.done)return delete r.err,r;let o=r.why||"custom",i=d(t);if("string"==typeof r.err)t.err.push(q(t,r.err));else if("object"==typeof r.err)t.err.push(...[r.err].flat().map(e=>(e.p=null==e.p?i:e.p,e.m=null==e.m?2010:e.m,e)));else{let r=e.name;null!=r&&""!=r||(r=N(e.toString().replace(/[ \t\r\n]+/g," "))),t.err.push(M(o,t,1045,void 0,{thrown:n},r))}r.done=null==r.done||r.done}return r.hasOwnProperty("uval")?t.updateVal(r.val):void 0===r.val||Number.isNaN(r.val)?"custom"===t.node.t&&(t.ignoreVal=!0):t.updateVal(r.val),void 0!==r.node&&(t.node=r.node),void 0!==r.type&&(t.type=r.type),r}function d(e){return e.path.slice(1,e.dI+1).filter(e=>null!=e).join(".")}const h=function(e){let t=T(this,e);return t.r=!0,void 0===e&&1===arguments.length&&(t.t="undefined",t.v=void 0),t},v=function(e){let t=T(this,e);return t.r=!1,t.o=!0,t},m=function(e){let t=T(this,e);return t.u.empty=!0,t},b=function(e){let t=T(this,e);return t.t="any",void 0!==e&&(t.v=e),t},y=function(e){let t=T(this,e);return t.t="never",t},g=function(...e){let t=T();t.t="list",t.r=!0;let n=e.map(e=>H(e));return t.u.list=e,t.b.push((function(t,r,o){let i=!0;for(let e of n){let n={...o.ctx,err:[]};e(t,n),0<n.err.length&&(i=!1)}return i||(r.why="all",r.err=[q(o,'Value "$VALUE" for path "$PATH" does not satisfy all of: '+e.map(e=>L(e)))]),i})),t},I=function(...e){let t=T();t.t="list",t.r=!0;let n=e.map(e=>H(e));return t.u.list=e,t.b.push((function(t,r,o){let i=!1;for(let e of n){let n={...o.ctx,err:[]};if(i||(i=e.match(t,n)),i)break}return i||(r.why="some",r.err=[q(o,'Value "$VALUE" for path "$PATH" does not satisfy some of: '+e.map(e=>L(e)))]),i})),t},$=function(...e){let t=T();t.t="list",t.r=!0;let n=e.map(e=>H(e));return t.u.list=e,t.b.push((function(t,r,o){let i=0;for(let e of n){let n={...o.ctx,err:[]};e.match(t,n)&&i++}return 1!==i&&(r.why="one",r.err=[q(o,'Value "$VALUE" for path "$PATH" does not satisfy one of: '+e.map(e=>L(e)))]),!0})),t},A=function(...e){let t=T();return t.b.push((function(t,n,r){for(let o=0;o<e.length;o++)if(t===e[o])return!0;return n.err=q(r,`Value "$VALUE" for path "$PATH" must be exactly one of: ${r.node.s}.`),n.done=!0,!1})),t.s=e.map(e=>L(e)).join(","),t},j=function(e,t){let n=T(this,t);return n.b.push(e),n},w=function(e,t){let n=T(this,t);return n.a.push(e),n},k=function(e){let t=T(this,e);return t.b.push((function(e,n,r){if(null!=e&&"object"==typeof e&&!Array.isArray(e)){let o=Object.keys(e),i=t.v;n.err=[];for(let e of o)void 0===i[e]&&n.err.push(M("closed",r,3010,"",{k:e}));return 0===n.err.length}return!0})),t},x=function(e,t){let n=T(this,t),r="string"==typeof e?e:("object"==typeof e&&e||{}).name;return null!=r&&""!=r&&n.b.push((function(e,t,n){return(n.ctx.ref=n.ctx.ref||{})[r]=n.node,!0})),n},O=function(e,t){let n=T(this,t),r="object"==typeof e&&e||{},o="string"==typeof e?e:r.name,i=!!r.fill;return null!=o&&""!=o&&n.b.push((function(e,t,n){if(void 0!==e||i){let e=n.ctx.ref=n.ctx.ref||{};if(void 0!==e[o]){let n={...e[o]};n.t=n.t||"never",t.node=n,t.type=n.t}}return!0})),n},R=function(e,t){let n=T(this,t),r="object"==typeof e&&e||{},o="string"==typeof e?e:r.name,i="boolean"==typeof r.keep?r.keep:void 0,l=Array.isArray(r.claim)?r.claim:[];if(null!=o&&""!=o){let e=(e,t,n)=>{if(void 0===e&&0<l.length){n.ctx.Rename=n.ctx.Rename||{},n.ctx.Rename.fromDefault=n.ctx.Rename.fromDefault||{};for(let e of l){let r=n.ctx.Rename.fromDefault[e]||{};if(void 0!==n.parent[e]&&!r.yes){t.val=n.parent[e],n.match||(n.parent[o]=t.val),t.node=r.node;for(let e=0;e<n.err.length;e++)n.err[e].k===r.key&&(n.err.splice(e,1),e--);if(i){let t=n.cI+1;n.nodes.splice(t,0,p(r.dval)),n.vals.splice(t,0,void 0),n.parents.splice(t,0,n.parent),n.keys.splice(t,0,e),n.nI++,n.pI++}else delete n.parent[e];break}}void 0===t.val&&(t.val=n.node.v)}return!0};Object.defineProperty(e,"name",{value:"Rename:"+o}),n.b.push(e);let t=(e,t,n)=>(n.parent[o]=e,n.match||i||n.key===o||Array.isArray(n.parent)&&!1!==i||(delete n.parent[n.key],t.done=!0),n.ctx.Rename=n.ctx.Rename||{},n.ctx.Rename.fromDefault=n.ctx.Rename.fromDefault||{},n.ctx.Rename.fromDefault[o]={yes:n.fromDefault,key:n.key,dval:n.node.v,node:n.node},!0);Object.defineProperty(t,"name",{value:"Rename:"+o}),n.a.push(t)}return n};function V(e){return"number"==typeof e?e:"number"==typeof(null==e?void 0:e.length)?e.length:null!=e&&"object"==typeof e?Object.keys(e).length:NaN}function N(e,t){let n=String(e),r=null==t||isNaN(t)?30:t<0?0:~~t,o=null==e?0:n.length,i=null==e?"":n.substring(0,o);return(i=r<o?i.substring(0,r-3)+"...":i).substring(0,r)}const S=function(e,t){let n=T(this,t);return n.b.push((function(t,n,r){let o=V(t);if(e<=o)return!0;let i="number"==typeof t?"":"length ";return n.err=q(r,`Value "$VALUE" for path "$PATH" must be a minimum ${i}of ${e} (was ${o}).`),!1})),n},E=function(e,t){let n=T(this,t);return n.b.push((function(t,n,r){let o=V(t);if(o<=e)return!0;let i="number"==typeof t?"":"length ";return n.err=q(r,`Value "$VALUE" for path "$PATH" must be a maximum ${i}of ${e} (was ${o}).`),!1})),n},G=function(e,t){let n=T(this,t);return n.b.push((function(t,n,r){let o=V(t);if(e<o)return!0;let i="number"==typeof t?"be":"have length";return n.err=q(r,`Value "$VALUE" for path "$PATH" must ${i} above ${e} (was ${o}).`),!1})),n},P=function(e,t){let n=T(this,t);return n.b.push((function(t,n,r){let o=V(t);if(o<e)return!0;let i="number"==typeof t?"be":"have length";return n.err=q(r,`Value "$VALUE" for path "$PATH" must ${i} below ${e} (was ${o}).`),!1})),n},D=function(e,t){let n=T(null==t?this:e),r=p(null==t?e:t);return n.a.push((function(e,t,n){if(null!=e){let t=Object.keys(n.node.v),o=Object.keys(e).reduce((e,n)=>(t.includes(n)||e.push(n),e),[]);if(0<o.length){let i=n.nI+o.length-1,l=n.nI;0<t.length?(l--,n.nodes[i]=n.nodes[l],n.vals[i]=n.vals[l],n.parents[i]=n.parents[l],n.keys[i]=n.keys[l]):(i++,n.nodes[i]=n.sI,n.pI=l);for(let t of o)n.nodes[l]=p(r,1+n.dI),n.vals[l]=e[t],n.parents[l]=e,n.keys[l]=t,l++;n.nI=i+1,n.nextSibling=!1,n.dI++}}return!0})),n};function T(e,t){let n=p(void 0===e||e.window===e?t:e);return Object.assign(n,{Above:G,After:w,Any:b,Before:j,Below:P,Closed:k,Define:x,Empty:m,Exact:A,Max:E,Min:S,Never:y,Optional:v,Refer:O,Rename:R,Required:h,Value:D})}function q(e,t,n,r){return M(n||"custom",e,4e3,t,r)}function M(e,t,n,r,o,i){let l={k:t.key,n:t.node,v:t.val,p:d(t),w:e,m:n,t:"",u:o||{}},u=N((void 0===t.val?"":L(t.val)).replace(/"/g,""));return l.t=null==r||""===r?`Validation failed for path "${l.p}" with value "${u}" because `+("type"===e?"instance"===t.node.t?`the value is not an instance of ${t.node.u.n} `:"the value is not of type "+t.node.t:"required"===e?"the value is required":"closed"===e?`the property "${null==o?void 0:o.k}" is not allowed`:"never"===e?"no value is allowed":`check "${e+(i?": "+i:"")}" failed`)+(l.u.thrown?" (threw: "+l.u.thrown.message+")":"."):r.replace(/\$VALUE/g,u).replace(/\$PATH/g,l.p),l}function L(e,t,n){try{let r=JSON.stringify(e,(e,r)=>{var i,l;if(t&&(r=t(e,r)),null!=r&&"object"==typeof r&&r.constructor&&"Object"!==r.constructor.name&&"Array"!==r.constructor.name)r="function"==typeof r.toString?r.toString():r.constructor.name;else if("function"==typeof r)r="function"==typeof f[r.name]&&isNaN(+e)?void 0:null!=r.name&&""!==r.name?r.name:N(r.toString().replace(/[ \t\r\n]+/g," "));else if("bigint"==typeof r)r=String(r.toString());else{if(Number.isNaN(r))return"NaN";!0===n||!0!==(null===(i=null==r?void 0:r.$)||void 0===i?void 0:i.gubu$)&&o!==(null===(l=null==r?void 0:r.$)||void 0===l?void 0:l.gubu$)||(r=null==r.s||""===r.s?r.t:r.s)}return r});return String(r)}catch(r){return JSON.stringify(String(e))}}function _(e){return null==e||"object"!=typeof e?e:JSON.parse(JSON.stringify(e))}const B=e=>p({...e,$:{gubu$:!0}});if("undefined"!=typeof window){let e=[{b:G,n:"Above"},{b:w,n:"After"},{b:g,n:"All"},{b:b,n:"Any"},{b:j,n:"Before"},{b:P,n:"Below"},{b:k,n:"Closed"},{b:x,n:"Define"},{b:m,n:"Empty"},{b:A,n:"Exact"},{b:E,n:"Max"},{b:S,n:"Min"},{b:y,n:"Never"},{b:$,n:"One"},{b:v,n:"Optional"},{b:O,n:"Refer"},{b:R,n:"Rename"},{b:h,n:"Required"},{b:I,n:"Some"},{b:D,n:"Value"}];for(let t of e)Object.defineProperty(t.b,"name",{value:t.n})}Object.assign(f,{Above:G,After:w,All:g,Any:b,Before:j,Below:P,Closed:k,Define:x,Empty:m,Exact:A,Max:E,Min:S,Never:y,One:$,Optional:v,Refer:O,Rename:R,Required:h,Some:I,Value:D,GAbove:G,GAfter:w,GAll:g,GAny:b,GBefore:j,GBelow:P,GClosed:k,GDefine:x,GEmpty:m,GExact:A,GMax:E,GMin:S,GNever:y,GOne:$,GOptional:v,GRefer:O,GRename:R,GRequired:h,GSome:I,GValue:D,G$:B,buildize:T,makeErr:q,stringify:L,truncate:N,Args:U}),Object.defineProperty(f,"name",{value:"gubu"});const H=f;function U(e,t){function n(e){return"function"==typeof e?B({v:e}):e}let r=void 0,o=Object.keys(e).reduce((t,o,i,l)=>{if(o.startsWith("...")&&i+1===l.length)r={name:o.substring(3),shape:n(e[o])};else{let r=o,l=(o.split(":")[1]||"").split(",").filter(e=>""!==e);0<l.length?o=r.split(":")[0]:l=void 0,t[i+1]=R({name:o,claim:l,keep:!0},n(e[r]))}return t},[y()]);r&&(o[0]=w((e,t,n)=>(n.parent[r.name]=n.parent[r.name]||[],n.parent[r.name].push(e),!0),r.shape),o=w((e,t,n)=>(e&&(e[r.name]=e[r.name]||[]),!0),o));let i=H(o);if(t){let e=function(){let e=Array.prototype.slice.call(arguments),n=i(e);return t.call(this,n)};return null!=t.name&&""!=t.name&&Object.defineProperty(e,"name",{value:t.name+"_args"}),e}return i}t.Gubu=H;const{Gubu:C}=t;return C}));